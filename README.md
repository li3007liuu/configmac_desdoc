# configmac_desdoc(智能配药机设计文档)
## 嵌入式设备与服务器后台通信说明
嵌入式设备通过tcp连接，实现与服务器后台之间通信，小程序通过http协议与嵌入式设备之间实现通信。

下面记录嵌入式设备通信API格式：
整个协议帧包含<br>数据头（2Byte） 设备唯一标志码PID（8Byte） 协议类型（1Byte） 数据帧长度（1Byte） 数据帧（xxByte） CRC校验（2Byte） 数据尾（2Byte）<br/>
控制命令帧数据帧格式为
<br>控制命令（1Byte）控制命令参数个数（1Byte）参数类型0（1Byte）参数值0（nByte）参数类型1（1Byte）参数值1（nByte）……<br/>

控制命令对应如下：（hex）控制命令描述<br/>
01 设备注册     
02 更新密码     
03 更新设备状态     
1E 添加药瓶     
1F 删除药瓶     
20 开始配药     

错误码类型如下：<br/>
07 长度错误       
06 数据头尾校验错误     
05 数据CRC校验错误      
04 协议帧类型错误      
03 数据dat转换错误      
00 正确返回     

### 01设备注册
描述：通过设备MAC地址及密码向服务器端注册设备，换取设备唯一标志码PID。<br/>
参数总数：6<br/>
参数1：产品系列编码 参数类型 10 参数位数1Byte <br/>
参数2：产品类型编码 参数类型 11 参数位数1Byte<br/>
参数3：产品批次编码 参数类型 12 参数位数1Byte<br/>
参数4：配药机可操作药瓶总数 参数类型 15 参数位数1Byte<br/>
参数5：设备MAC地址 参数类型 C0 参数位数8Byte<br/>
参数6：设备初始密码 参数地址 C1 参数位数8Byte<br/>
成功返回：<br/>
参数1：返回错误码 参数类型 00 参数位数1Byte<br/>
参数2：返回注册成功PID 参数类型 C2 参数位数8Byte<br/>
错误返回：<br/>
参数1：返回错误码 参数类型 00 参数位数1Byte<br/>
示例请求：<br/>
FFFE<br/>
0000000000000000 -》设备ID注册时ID为全0<br/>
A3 -》帧类型嵌入式设备请求控制帧<br/>
1C -》数据总数<br/>
01 -》控制命令编码 01 为设备注册<br/>
06 -》控制命令参数个数 为6个参数个数<br/>
10 -》产品系列编码<br/>
0B -》0B为配药机系列<br/>
11 -》产品类型编码<br/>
01 -》01为配药机产品类型<br/>
12 -》产品批次编码<br/>
00 -》产品批次为00<br/>
15 -》设备单元总数编码<br/>
07 -》有七个设备单元<br/>
C0 -》设备MAC地址编码<br/>
0000000000000000<br/>
C1 -》设备Pass地址编码<br/>
0000000000000000<br/>
AA25<br/>
FFFD<br/>
成功返回：<br/>
FFFE<br/>
0000000000000000<br/>
23-》帧类型<br/>
0D-》数据总数<br/>
01-》控制命令编码01为设备注册<br/>
02-》返回参数个数02<br/>
00-》返回错误码<br/>
00-》0为无错误<br/>
C2-》返回pid<br/>
0B01000000000585<br/>
8C04<br/>
FFFD<br/>
错误返回<br/>
FFFE <br/>
0000000000000000<br/>
20-》帧类型<br/>
02-》数据总数<br/>
00-》返回错误码类型<br/>
05-》返回错误码值<br/>
010E<br/> 
FFFD<br/>
### 2更新密码
描述：通过设备PID修改服务器端设备的操作密码。<br/>
参数总数：1<br/>
参数1：设备密码 参数类型 C1 参数位数8Byte <br/>
成功返回：<br/>
参数1：返回错误码 参数类型 00 参数位数1Byte<br/>
参数2：返回更新后的密码 参数类型 C1 参数位数8Byte<br/>
错误返回：<br/>
参数1：返回错误码 参数类型 00 参数位数1Byte<br/>
发送示例：
FFFE<br/>
0B01000000000585 =》设备PID<br/>
A3 =》协议类型<br/>
0D =》数据包数据总数<br/>
02 =》控制命令更新密码<br/>
01 =》控制命令参数个数<br/>
C1 =》参数密码值类型<br/>
0000000000000002 =》参数密码<br/>
D355 =》校验<br/>
FFFD<br/>
### 3更新配药机状态
描述：通过设备PID修改服务器端设备的工作状态。<br/>
参数总数：1<br/>
参数1：设备状态 参数类型 13 参数位数1Byte <br/>
成功返回：<br/>
参数1：返回错误码 参数类型 00 参数位数1Byte<br/>
参数2：返回设备状态 参数类型 13 参数位数1Byte <br/>
错误返回：<br/>
参数1：返回错误码 参数类型 00 参数位数1Byte<br/>
发送示例：<br/>
FFFE<br/>
0B01000000000585=》设备PID<br/>
A3=》设备协议类型<br/>
04=》数据包数据总数<br/>
03=》控制命令更新配药机状态<br/>
01=》控制命令参数个数<br/>
13=》设备状态参数类型<br/>
02=》设备正忙值<br/>
9A83<br/>
FFFD<br/>
返回示例:<br/>
FFFE<br/>
0B01000000000585=》设备PID<br/>
23=》设备协议类型<br/>
06=》数据包数据总数<br/>
03=》控制命令更新配药机状态<br/>
02=》返回参数个数2<br/>
00=》返回错误码类型<br/>
00=》返回错误码值<br/>
13=》返回设备状态类型<br/>
02=》返回设备状态值<br/>
4EA7<br/>
FFFD<br/>
### 1E小程序通过服务器后台控制嵌入式设备进行药瓶添加操作
流程：<br/>1.小程序http请求到服务器后台执行添加药瓶操作，<br/>2.服务器后台通过当前在线设备转发药瓶添加操作，<br/>3.嵌入式设备接收到添加药瓶操作后，执行添加药瓶操作，<br/>4.嵌入式设备执行完成添加药瓶操作后，返回操作响应给服务器后台，<br/>5.服务器后台接收到返回响应后，更新药瓶数据库，药瓶添加完成。<br/>
* 小程序向服务器发送添加药瓶操作示例<br/>
{"server":"Wxminserver","action":"addyaoping","data":{"pid":"0B01000000000585","openid":"li3007liuu","unitn":2,"ypnum":"200236473"}}<br/>
* 服务器向设备发送添加药瓶操作命令<br/>
描述:通过设备PID向指定设备发送添加药瓶操作<br/>
参数总数：2<br/>
参数1：操作用户 参数类型 60 参数位数4Byte <br/>
参数2：操作的配药机的单元号 参数类型 62~69 对应配药机单元0~7号 参数位数4Byte <br/> 若用户将ID为00000001的瓶添加至单元0则此次参数2为6200000001<br/>
示例：用户编号为00000001，对配药机单元1添加药瓶编号为000186A1命令如下<br/>
FFFE <br/>
0B01000000000585<br/>
43=》协议帧类型<br/>
0C=》数据包总数<br/>
1E=》添加药瓶操作<br/>
02=》传递参数2<br/>
60=》操作用户类型 <br/>
00000001=》操作用户编号 <br/>
64=》需要添加的单元地址 <br/>
000186A1=》需要添加的药瓶编号<br/>
0915 <br/>
FFFD<br/>
* 添加药瓶结束后，设备向服务器返回响应<br/>
参数总数:3<br/>
参数1：操作状态码 参数类型00 参数位数1Byte<br/>
参数2：操作用户 参数类型 60 参数位数4Byte <br/>
参数3：操作的配药机的单元号 参数类型 62~69 对应配药机单元0~7号 参数位数4Byte <br/> 若用户将ID为00000001的瓶添加至单元0则此次参数2为6200000001<br/>
FFFE<br/>
0B01000000000585<br/>
A3=》协议类型<br/>
0E=》数据包总数<br/>
1E=》添加药瓶操作<br/>
03=》返回参数总数<br/>
00=》错误状态类型<br/>
00=》错误状态码<br/>
60=》操作用户<br/>
00000001<br/>
64=》配药机单元及药瓶编号<br/>
000186A1<br/>
E5FA<br/>
FFFD<br/>
### 1F小程序通过服务器后台控制嵌入式设备进行药瓶删除操作
流程：<br/>1.小程序http请求到服务器后台执行删除药瓶操作，<br/>2.服务器后台通过当前在线设备转发药瓶删除操作，<br/>3.嵌入式设备接收到删除药瓶操作后，执行删除药瓶操作，<br/>4.嵌入式设备执行完成删除药瓶操作后，返回操作响应给服务器后台，<br/>5.服务器后台接收到返回响应后，更新药瓶数据库，药瓶删除完成。<br/>
* 小程序向服务器发送删除药瓶操作示例<br/>
{"server":"Wxminserver","action":"deleteyaoping","data":{"pid":"0B01000000000190","openid":"li3007liuu","unitn":2}}<br/>
* 服务器向设备发送删除药瓶操作命令<br/>
描述:通过设备PID向指定设备发送删除药瓶操作<br/>
参数总数：2<br/>
参数1：操作用户 参数类型 60 参数位数4Byte <br/>
参数2：操作的配药机的单元号 参数类型 62~69 对应配药机单元0~7号 参数位数4Byte <br/>
示例：用户编号为00000001，对配药机单元1删除药瓶命令如下<br/>
FFFE <br/>
0B01000000000585<br/>
43=》协议帧类型<br/>
0C=》数据包总数<br/>
1F=》添加药瓶操作<br/>
02=》传递参数2<br/>
60=》操作用户类型 <br/>
00000001=》操作用户编号 <br/>
64=》需要删除的单元地址 <br/>
00000000<br/>
0915 <br/>
FFFD<br/>
* 药瓶删除结束后，设备向服务器返回响应<br/>
参数总数:3<br/>
参数1：操作状态码 参数类型00 参数位数1Byte<br/>
参数2：操作用户 参数类型 60 参数位数4Byte <br/>
参数3：操作的配药机的单元号 参数类型 62~69 对应配药机单元0~7号 参数位数4Byte <br/>
FFFE<br/>
0B01000000000585<br/>
A3=》协议类型<br/>
0E=》数据包总数<br/>
1F=》删除药瓶操作<br/>
03=》返回参数总数<br/>
00=》错误状态类型<br/>
00=》错误状态码<br/>
60=》操作用户<br/>
00000001<br/>
64=》配药机单元号地址<br/>
00000000<br/>
E5FA<br/>
FFFD<br/>
### 20小程序通过服务器后台控制嵌入式设备进行配药操作
流程：<br/>1.小程序http请求到服务器后台执行配药操作，<br/>2.服务器后台通过当前在线设备转发配药操作，<br/>3.嵌入式设备接收到配药操作后，执行配药操作，<br/>4.嵌入式设备执行完成配药操作后，返回操作响应给服务器后台，<br/>5.服务器后台接收到返回响应后，更新药瓶数据库，配药完成。<br/>
* 小程序向服务器发送配药操作示例<br/>
{"server":"Wxminserver","action":"startconfig","data":{"pid":"0B01000000000108","openid":"li3007liuu","yaoftbid":0,"cfgallcap":1500,"decarr":[{"index":0,"dcap":300,"ypid":1},{"index":1,"dcap":400,"ypid":2}]}}<br/>
用户控制配药机在单元0流出300mL、单元1流出400mL值
* 服务器向设备发送配药操作命令<br/>
描述:通过设备PID向指定设备发送配药操作<br/>
操作示例： 
FFFE <br/>
0B01000000000585<br/>
43=》协议帧类型<br/>
21<br/>
20<br/>
07<br/>
60=》操作用户<br/>
00000001<br/>
7F=》配药总量<br/>
000005DC<br/>
7E=》配药药方ID<br/>
00000000<br/>
40=》单元0配药总量<br/>
012C<br/>
62=》单元0药瓶ID<br/>
00000001<br/>
41=》单元1配药总量<br/>
01 90 <br/>
63=》单元1药瓶ID<br/>
00 00 00 02 <br/>
18 DA <br/>
FF FD<br/>
* 配药结束后，设备向服务器返回响应<br/>
返回示例：
FFFE<br/>
0B01000000000585<br/>
A3=》协议类型<br/>
21<br/>
20=》配药操作<br/>
08=》参数个数<br/>
00=》错误码<br/>
00<br/>
60=》操作用户<br/>
00000001<br/>
7F=》配药总量<br/>
000005DC<br/>
7E=》配药药方ID<br/>
00000000<br/>
40=》单元0配药总量<br/>
012C<br/>
62=》单元0药瓶ID<br/>
00000001<br/>
41=》单元1配药总量<br/>
01 90 <br/>
63=》单元1药瓶ID<br/>
00000002 <br/>
5F=》配药总时间<br/>
00000300 <br/>

18DA<br/>
FFFD<br/>
